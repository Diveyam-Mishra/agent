<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agent UI</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        #chat { border: 1px solid #ccc; height: 400px; overflow-y: auto; padding: 10px; }
        #chat .message { margin-bottom: 10px; }
        #chat .image { max-width: 100%; margin-bottom: 10px; }
        #controls { margin-bottom: 20px; }
        input, button { padding: 5px; margin-right: 10px; }
    </style>
</head>
<body>
    <h1>Agent Runner</h1>
    <div id="controls">
        <label>Task Excel: <input type="text" id="task_excel" value="Book1.xlsx"></label>
        <label>Conversation Path: <input type="text" id="conversation" value="convo/conversation.txt"></label>
        <button id="startBtn">Start Agent</button>
    </div>
    <div id="chat"></div>

    <script>
    const startBtn = document.getElementById('startBtn');
    const chatDiv = document.getElementById('chat');

    function appendMessage(text) {
        const el = document.createElement('div');
        el.className = 'message';
        el.textContent = text;
        chatDiv.appendChild(el);
        chatDiv.scrollTop = chatDiv.scrollHeight;
    }

    function appendImage(src) {
        const img = document.createElement('img');
        img.className = 'image';
        img.src = src;
        chatDiv.appendChild(img);
        chatDiv.scrollTop = chatDiv.scrollHeight;
    }

    startBtn.addEventListener('click', async () => {
        chatDiv.innerHTML = '';
        const task_excel = document.getElementById('task_excel').value;
        const conversation = document.getElementById('conversation').value;
        try {
            const resp = await fetch('http://127.0.0.1:8000/start', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ task_excel, conversation_path: conversation })
            });
            if (!resp.ok) throw new Error('Start request failed');
            const data = await resp.json();
            const session = data.session;
            appendMessage('Agent session started: ' + session);

            const ws = new WebSocket((location.protocol === 'https:' ? 'wss://' : 'ws://') + location.host + '/ws/' + session);
            ws.onmessage = (event) => {
                try {
                    const msg = JSON.parse(event.data);
                    if (msg.result) {
                        appendMessage('Result: ' + msg.result);
                    } else if (msg.step) {
                        appendMessage('Step: ' + msg.step);
                    } else if (msg.screenshot) {
                        appendImage('data:image/png;base64,' + msg.screenshot);
                    } else {
                        appendMessage(JSON.stringify(msg));
                    }
                } catch (e) {
                    appendMessage('Invalid JSON: ' + event.data);
                }
            };
            ws.onclose = () => appendMessage('WebSocket closed');
        } catch (err) {
            appendMessage('Error: ' + err.message);
        }
    });
    </script>
</body>
</html>
